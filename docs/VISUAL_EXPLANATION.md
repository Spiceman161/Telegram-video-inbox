# Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±ÑŠÑÑĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ¸ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ

## ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: Ğ Ğ°ÑÑ‚ÑĞ½ÑƒÑ‚Ğ¾Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾

### Ğ”Ğ¾ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ

```
Original Video          Telegram Processing        Downloaded Video
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚           â”‚              â”‚           â”‚              â”‚
â”‚  16:9    â”‚  â”€â”€â”€â–º     â”‚   ??? x ???  â”‚  â”€â”€â”€â–º     â”‚   STRETCHED  â”‚
â”‚          â”‚           â”‚              â”‚           â”‚              â”‚
â”‚ 1920x1080â”‚           â”‚ (auto-detect)â”‚           â”‚   16:9 â†’ ?   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                       Telegram guesses
                       wrong dimensions
                       
Result: Video is stretched horizontally ğŸ˜
```

### ĞŸĞ¾ÑĞ»Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ

```
Original Video          Metadata Extract          Telegram Processing        Downloaded Video
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚           â”‚              â”‚          â”‚              â”‚           â”‚          â”‚
â”‚  16:9    â”‚  â”€â”€â”€â–º     â”‚  1920 x 1080 â”‚  â”€â”€â”€â–º    â”‚  1920 x 1080 â”‚  â”€â”€â”€â–º     â”‚  16:9    â”‚
â”‚          â”‚           â”‚              â”‚          â”‚              â”‚           â”‚          â”‚
â”‚ 1920x1080â”‚           â”‚  (ffprobe)   â”‚          â”‚  (explicit)  â”‚           â”‚ 1920x1080â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                       We tell Telegram
                       exact dimensions
                       
Result: Video preserves aspect ratio âœ…
```

## ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

### Ğ¨Ğ°Ğ³ 1: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ²Ğ¸Ğ´ĞµĞ¾

```
User                    Bot                     File System
  â”‚                      â”‚                          â”‚
  â”‚  "Download video"    â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
  â”‚                      â”‚  Get file path           â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                      â”‚  video.mp4 path          â”‚
  â”‚                      â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

### Ğ¨Ğ°Ğ³ 2: Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (ĞĞĞ’ĞĞ•!)

```
Bot                    ffprobe                 Video File
  â”‚                      â”‚                          â”‚
  â”‚  Extract metadata    â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
  â”‚                      â”‚  Read video stream       â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                      â”‚  Stream data             â”‚
  â”‚                      â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                          â”‚
  â”‚  {width: 1920,       â”‚                          â”‚
  â”‚   height: 1080,      â”‚                          â”‚
  â”‚   duration: 120}     â”‚                          â”‚
  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
```

### Ğ¨Ğ°Ğ³ 3: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸

```
Bot                    Telegram API            User
  â”‚                      â”‚                      â”‚
  â”‚  send_video(         â”‚                      â”‚
  â”‚    video=path,       â”‚                      â”‚
  â”‚    width=1920,   â†â”€â”€â”€â”¼â”€ Explicit metadata  â”‚
  â”‚    height=1080,  â†â”€â”€â”€â”¼â”€ ensures correct    â”‚
  â”‚    duration=120  â†â”€â”€â”€â”¼â”€ aspect ratio       â”‚
  â”‚  )                   â”‚                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
  â”‚                      â”‚  Video (preserved)   â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                      â”‚                      â”‚ âœ… Correct!
```

## Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     handle_download()                            â”‚
â”‚                                                                  â”‚
â”‚  1. Get file_info from file_manager                             â”‚
â”‚  2. Call get_video_metadata(file_path)                          â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”œâ”€â–º ffprobe -v quiet -print_format json ...                 â”‚
â”‚     â”‚                                                            â”‚
â”‚     â””â”€â–º Returns: {width: X, height: Y, duration: Z}             â”‚
â”‚                                                                  â”‚
â”‚  3. if metadata exists:                                         â”‚
â”‚       send_video(video, width=X, height=Y, duration=Z)          â”‚
â”‚     else:                                                        â”‚
â”‚       send_video(video)  # Fallback without metadata            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ĞšĞ¾Ğ´Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº

```python
# BEFORE (Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°)
await context.bot.send_video(
    chat_id=chat_id,
    video=file_path,
    caption="Video"
    # âŒ Telegram guesses dimensions â†’ wrong aspect ratio
)

# AFTER (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ)
metadata = get_video_metadata(file_path)
if metadata:
    await context.bot.send_video(
        chat_id=chat_id,
        video=file_path,
        caption="Video",
        width=metadata['width'],      # âœ… Explicit width
        height=metadata['height'],    # âœ… Explicit height
        duration=metadata['duration'], # âœ… Explicit duration
        supports_streaming=True
    )
```

## Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Python Bot                         â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  bot/handlers/callbacks.py                   â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  handle_download() â”€â”€â–º get_video_metadata()  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                          â”‚
â”‚                          â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  bot/utils/video_metadata.py                 â”‚  â”‚
â”‚  â”‚                                               â”‚  â”‚
â”‚  â”‚  get_video_metadata() â”€â”€â–º subprocess.run()   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚     ffprobe     â”‚  â† System dependency
                  â”‚   (from ffmpeg) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ âœ…

```
1. User sends video to bot
2. Bot saves video to SHARED_DIR
3. User requests download
4. Bot extracts metadata with ffprobe âœ…
5. Bot sends video with explicit dimensions âœ…
6. User receives video with correct aspect ratio âœ…
```

### Fallback ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ âš ï¸

```
1. User sends video to bot
2. Bot saves video to SHARED_DIR
3. User requests download
4. Bot tries to extract metadata
   â””â”€â–º ffprobe not installed or fails âŒ
5. Bot sends video WITHOUT metadata âš ï¸
6. User receives video (may have wrong aspect ratio)
```

### ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ (SEND_AS=document) ğŸ“„

```
1. User sends video to bot
2. Bot saves video to SHARED_DIR
3. User requests download
4. Bot sends video as DOCUMENT (not video) ğŸ“„
5. User receives file (no processing by Telegram) âœ…
6. Video has correct aspect ratio (but no preview) âœ…
```

## ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

```ini
# .env

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± (Ñ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸)
SEND_AS=video           # Uses get_video_metadata()
                        # Requires: ffmpeg installed
                        # Result: Video with preview + correct aspect ratio
                        
# ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± (Ğ±ĞµĞ· Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
SEND_AS=document        # No metadata needed
                        # Result: File without preview but correct aspect ratio
```

---

Ğ­Ñ‚Ğ° Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ:
1. **Ğ’ Ñ‡ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°** - Telegram Ğ½Ğµ Ğ·Ğ½Ğ°ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ¸ Ğ¸ÑĞºĞ°Ğ¶Ğ°ĞµÑ‚ Ğ²Ğ¸Ğ´ĞµĞ¾
2. **ĞšĞ°Ğº Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚** - ĞœÑ‹ ÑĞ¾Ğ¾Ğ±Ñ‰Ğ°ĞµĞ¼ Telegram Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹
3. **ĞšĞ°ĞºĞ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½ÑƒĞ¶Ğ½Ñ‹** - ffmpeg Ğ´Ğ»Ñ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
4. **Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…** - Fallback Ğ½Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ Ğ±ĞµĞ· Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
