# Changelog - Исправление соотношения сторон видео

## [2026-01-06] - Aspect Ratio Fix

### Исправлено
- **Растянутое видео при скачивании через бота**: Теперь видео сохраняет корректное соотношение сторон при скачивании через Telegram

### Добавлено
- Новая утилита **`bot/utils/video_metadata.py`** для извлечения метаданных видео
  - Функция `get_video_metadata()` - извлекает ширину, высоту, продолжительность
  - Функция `get_video_dimensions()` - shortcut для получения только размеров
  - Использует `ffprobe` для чтения метаданных
  - Обработка ошибок с silent fallback

- **Автоматическая установка зависимостей** (`scripts/install_dependencies.sh`)
  - Определяет окружение (Termux/Debian/RHEL)
  - Автоматически устанавливает системные пакеты (Python, Git, **ffmpeg**)
  - Устанавливает Python зависимости из requirements.txt
  - Создает необходимые директории (logs/, tmp/)
  - Настраивает .env файл из .env.example
  - Проверяет наличие ffmpeg после установки

- **Проверка ffmpeg при запуске** (`bot/main.py`)
  - При старте бота проверяется наличие ffprobe
  - Выводится предупреждение, если ffmpeg не установлен
  - Подсказка по установке (pkg/apt install ffmpeg)

- Документация **`docs/ASPECT_RATIO_FIX.md`**
  - Описание проблемы и решения
  - Технические детали использования ffprobe
  - Инструкции по установке и тестированию

- Документация **`docs/AUTO_INSTALL.md`**
  - Руководство по использованию автоматической установки
  - Поддерживаемые платформы
  - Устранение неполадок
  - Примеры вывода скрипта

- Дополнительная документация:
  - **`docs/BUGFIX_SUMMARY.md`** - полная сводка исправления
  - **`docs/TESTING_ASPECT_RATIO.md`** - руководство по тестированию
  - **`docs/VISUAL_EXPLANATION.md`** - визуальные диаграммы
  - **`scripts/test_aspect_ratio_fix.sh`** - тестовый скрипт

### Изменено
- **`bot/handlers/callbacks.py`** → функция `handle_download()`:
  - Теперь извлекает метаданные видео перед отправкой
  - Передает `width`, `height`, `duration` и `supports_streaming=True` в `send_video()`
  - Fallback на отправку без метаданных при ошибке извлечения

- **`README.md`**:
  - Добавлен ffmpeg в список требований
  - Обновлена команда установки: `pkg install python git ffmpeg`

- **`docs/INSTALLATION.md`**:
  - Добавлен ffmpeg в шаг 3.2 (Установка базовых инструментов)

### Технические детали

**Проблема:**
При отправке видео через `send_video()` без явных параметров `width` и `height`, Telegram может неправильно определить соотношение сторон, что приводит к растяжению видео по ширине.

**Решение:**
1. Извлекаем метаданные с помощью `ffprobe` перед отправкой
2. Передаем корректные `width`, `height`, `duration` в `send_video()`
3. Telegram использует эти данные вместо собственного анализа, сохраняя пропорции

**Требования:**
- `ffmpeg` (включает `ffprobe`) должен быть установлен
- На Termux: `pkg install ffmpeg`

**Поведение при ошибке:**
- Если `ffprobe` не установлен или не может прочитать файл, видео отправляется без метаданных
- Это fallback behavior, чтобы не блокировать отправку видео

### Файлы изменены

**Новый код:**
- ✅ `bot/utils/video_metadata.py` - NEW
- ✅ `scripts/install_dependencies.sh` - NEW
- ✅ `scripts/test_aspect_ratio_fix.sh` - NEW

**Измененный код:**
- ✅ `bot/handlers/callbacks.py` - MODIFIED (handle_download с метаданными)
- ✅ `bot/main.py` - MODIFIED (добавлена проверка ffmpeg)

**Документация:**
- ✅ `CHANGELOG.md` - NEW
- ✅ `docs/ASPECT_RATIO_FIX.md` - NEW
- ✅ `docs/AUTO_INSTALL.md` - NEW
- ✅ `docs/BUGFIX_SUMMARY.md` - NEW
- ✅ `docs/TESTING_ASPECT_RATIO.md` - NEW
- ✅ `docs/VISUAL_EXPLANATION.md` - NEW
- ✅ `README.md` - MODIFIED (добавлена автоматическая установка)
- ✅ `docs/INSTALLATION.md` - MODIFIED (добавлена автоматическая установка)

### Проверка работы
1. Убедитесь, что ffmpeg установлен: `ffprobe -version`
2. Отправьте видео боту
3. Скачайте его обратно через кнопку "⬇️ Скачать"
4. Проверьте соотношение сторон - должно совпадать с оригиналом

### Альтернативное решение
Если не хотите использовать ffprobe, можно отправлять видео как документы:
```env
SEND_AS=document
```
В этом случае Telegram не обрабатывает видео, и соотношение сторон сохраняется автоматически.
